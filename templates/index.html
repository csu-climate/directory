<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Members Directory</title>
  <link rel="stylesheet" href="{{ base_path }}/static/theme.css" />
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <img src="{{ base_path }}/static/climate-directory-logo.svg" alt="CSU Climate Directory Logo" class="logo">
      </div>
      <h1>CSU Climate Faculty Directory</h1>
      <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">
        <svg class="theme-icon" id="themeIcon" viewBox="0 0 24 24">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
        <span id="themeText">Dark Mode</span>
      </button>
    </div>

    <div class="search-section">
      <input 
        type="text" 
        class="search-bar" 
        placeholder="Search members by name, interests, ..." 
        id="searchInput"
      >

      <div class="filters">
        <div class="filter-group">
          <label for="department">Department</label>
          <select class="filter-select" id="department">
            <option value="">All Departments</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="campus">Campus</label>
          <select class="filter-select" id="campus">
            <option value="">All Campuses</option>
          </select>
        </div>
      </div>

      <div class="filter-tags" id="activeFilters"></div>
    </div>

    <div class="results-header">
      <h2>Members</h2>
      <div class="results-count" id="resultsCount">Loading...</div>
    </div>

    <div class="lessons-grid" id="cardsGrid"></div>

    <footer class="footer">
      <p>The Initiative for Climate Leadership and Resilience at Cal Poly.</p>
      <p>Facilitating collaboration on climate change solutions.</p>
    </footer>
  </div>

<script>
  // === Theme management ===
  function setThemeUI(isDark) {
    const themeIcon = document.getElementById('themeIcon');
    const themeText = document.getElementById('themeText');
    if (isDark) {
      themeIcon.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
      themeText.textContent = 'Light Mode';
    } else {
      themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
      themeText.textContent = 'Dark Mode';
    }
  }

  function toggleTheme() {
    const body = document.body;
    const willBeDark = !body.classList.contains('dark-theme');
    body.classList.toggle('dark-theme', willBeDark);
    localStorage.setItem('theme', willBeDark ? 'dark' : 'light');
    setThemeUI(willBeDark);
  }

  function loadTheme() {
    const savedTheme = localStorage.getItem('theme');
    const isDark = savedTheme === 'dark';
    document.body.classList.toggle('dark-theme', isDark);
    setThemeUI(isDark);
  }

  // === Helpers ===
  function $id(id) { return document.getElementById(id); }
  function uniq(values) {
    return [...new Set(values.filter(Boolean).map(v => v.trim()))].sort((a,b)=>a.localeCompare(b));
  }
  function pillize(str) {
    if (!str) return [];
    return str.split(/[,;]+/).map(s => s.trim()).filter(Boolean);
  }

  // === Rendering ===
  function createMemberCard(m) {
    const interests = [...pillize(m['Research Interests']), ...pillize(m['Teaching Interests'])].slice(0, 8);
    const emailHTML = m['Email'] ? `<a href="mailto:${m['Email']}">${m['Email']}</a>` : '';
    const metaBits = [m['Department'], m['Campus']].filter(Boolean).join(' Â· ');

    const card = document.createElement('div');
    card.className = 'lesson-card';
    card.innerHTML = `
      <div class="lesson-title">${m['Name'] || '(No name)'}</div>
      <div class="lesson-description">${metaBits}</div>
      <div class="lesson-meta">
        ${emailHTML ? `<div class="meta-item"><span class="meta-label">Email:</span><span class="meta-value">${emailHTML}</span></div>` : ''}
        ${m['Sustainability Contributions'] ? `<div class="meta-item"><span class="meta-label">Sustainability:</span><span class="meta-value">${m['Sustainability Contributions']}</span></div>` : ''}
        ${m['Notes'] ? `<div class="meta-item"><span class="meta-label">Notes:</span><span class="meta-value">${m['Notes']}</span></div>` : ''}
      </div>
      ${interests.length ? `<div class="lesson-tags">${interests.map(t=>`<span class="tag">${t}</span>`).join('')}</div>` : ''}
    `;
    return card;
  }

  function applyFilters() {
    const q = ($id('searchInput')?.value || '').toLowerCase();
    const department = $id('department') ? $id('department').value : '';
    const campus = $id('campus') ? $id('campus').value : '';

    const filtered = MEMBERS.filter(m => {
      const blob = [
        m['Name'], m['Research Interests'], m['Teaching Interests'],
        m['Notes'], m['Sustainability Contributions'],
        m['Department'], m['Campus'], m['Email']
      ].join(' ').toLowerCase();
      if (q && !blob.includes(q)) return false;
      if (department && m['Department'] !== department) return false;
      if (campus && m['Campus'] !== campus) return false;
      return true;
    });

    const grid = $id('cardsGrid');
    grid.innerHTML = '';
    filtered.forEach(m => grid.appendChild(createMemberCard(m)));
    $id('resultsCount').textContent = `${filtered.length} of ${MEMBERS.length}`;

    const tagsEl = $id('activeFilters');
    tagsEl.innerHTML = '';
    const active = [];
    if ($id('department') && department) active.push({label:'Department', value:department, id:'department'});
    if ($id('campus') && campus)       active.push({label:'Campus', value:campus, id:'campus'});
    active.forEach(f => {
      const t = document.createElement('span');
      t.className = 'filter-tag';
      t.innerHTML = `<strong>${f.label}:</strong> ${f.value} <button class="remove" aria-label="Clear ${f.label}">&times;</button>`;
      t.querySelector('button').addEventListener('click', () => {
        $id(f.id).value = '';
        applyFilters();
      });
      tagsEl.appendChild(t);
    });
  }

  // === App entry ===
  let MEMBERS = [];

  async function init() {
    loadTheme();

    const url = '{{ base_path }}/members.json?v=' + Date.now();
    console.log('Fetching members from:', url);

    let resp;
    try {
      resp = await fetch(url, { cache: 'no-store', headers: { 'Accept': 'application/json' } });
      if (!resp.ok) throw new Error(`HTTP ${resp.status} ${resp.statusText}`);
    } catch (e) {
      console.error('Failed to fetch members.json:', e);
      $id('resultsCount').textContent = 'Failed to load data';
      return;
    }

    let data;
    try {
      data = await resp.json();
    } catch (e) {
      console.error('members.json is not valid JSON:', e);
      $id('resultsCount').textContent = 'Bad data';
      return;
    }

    const normalize = (m) => ({
      ...m,
      Name: m.Name ?? m.name ?? '',
      Email: m.Email ?? m.email ?? '',
      Campus: m.Campus ?? m.campus ?? '',
      Department: m.Department ?? m.department ?? '',
      'Research Interests': m['Research Interests'] ?? m.Research_Interests ?? '',
      'Teaching Interests': m['Teaching Interests'] ?? m.Teaching_Interests ?? '',
      'Sustainability Contributions': m['Sustainability Contributions'] ?? m.Sustainability_Contributions ?? '',
      Notes: m.Notes ?? ''
    });

    MEMBERS = data.map(normalize);

    const departments = uniq(MEMBERS.map(m => m['Department']));
    const campuses    = uniq(MEMBERS.map(m => m['Campus']));

    function fill(id, values) {
      const sel = $id(id);
      if (!sel) return;
      const first = sel.querySelector('option:first-child');
      sel.innerHTML = ''; if (first) sel.appendChild(first);
      values.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
      sel.addEventListener('change', applyFilters);
    }

    if ($id('department')) fill('department', departments);
    if ($id('campus'))     fill('campus', campuses);

    const searchEl = $id('searchInput');
    if (searchEl) searchEl.addEventListener('input', applyFilters);

    applyFilters();
  }

  init();
</script>
</body>
</html>
