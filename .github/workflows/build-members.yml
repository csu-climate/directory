name: Build and Deploy Members Directory

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  BASE_PATH: "/${{ github.event.repository.name }}"
  
permissions:
  contents: write  # Needed to push to gh-pages branch

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml jinja2

    - name: Validate member files
      run: |
        echo "Validating YAML files in members/ ..."
        python - <<'PY'
        import yaml
        from pathlib import Path

        members_dir = Path('members')
        if not members_dir.exists():
            print('❌ No members directory found')
            raise SystemExit(1)

        yaml_files = sorted(list(members_dir.glob('*.yml')) + list(members_dir.glob('*.yaml')))
        if not yaml_files:
            print('❌ No YAML files found in members/')
            raise SystemExit(1)

        print(f'✅ Found {len(yaml_files)} member files')
        for y in yaml_files:
            try:
                with open(y, 'r', encoding='utf-8') as f:
                    yaml.safe_load(f)
                print(f'✅ {y.name} is valid')
            except Exception as e:
                print(f'❌ {y.name} is invalid: {e}')
                raise SystemExit(1)
        PY

    - name: Build members data
      run: |
        echo "Building members data..."
        python scripts/build_members.py

    - name: Prepare site for deployment
      run: |
        echo "Preparing site directory..."
        rm -rf site
        mkdir -p site/data

        # Use the members directory page as the landing page
        cp index.html site/index.html

        # Theme & assets
        if [ -f theme.css ]; then cp theme.css site/; fi
        if [ -f act-cms-logo.svg ]; then cp act-cms-logo.svg site/; fi
        if [ -f favicon.ico ]; then cp favicon.ico site/; fi

        # Data
        cp data/members.json site/data/

    - name: Deploy Site
      if: github.ref == 'refs/heads/main'
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        folder: ./site
